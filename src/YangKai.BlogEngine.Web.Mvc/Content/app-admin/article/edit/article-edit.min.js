angular.module("admin-article-edit",["resource.articles","resource.channels"]).factory("TranslateService",["$http",function(n){return{events:function(t){return n({method:"JSONP",url:"http://api.microsofttranslator.com/V2/Ajax.svc/Translate?oncomplete=JSON_CALLBACK&appId=A4D660A48A6A97CCA791C34935E4C02BBB1BEC1C&from=zh-cn&to=en&text="+t})}}}]).config(["$routeProvider",function(n){return n.when("/admin/article(':id')",{templateUrl:"/content/app-admin/article/edit/article-edit.tpl.html",controller:"ArticleEditCtrl"}).when("/admin/article/new",{templateUrl:"/content/app-admin/article/edit/article-edit.tpl.html",controller:"ArticleEditCtrl"})}]).controller("ArticleEditCtrl",["$scope","$routeParams","$window","$rootScope","uploadManager","Article","Channel","$timeout","TranslateService",function(n,t,i,r,u,f,e,o,s){var c,h;return n.channels=e.query({$expand:"Groups"},function(){return t.id?(n.loading="Loading",f.get({$filter:"PostId eq (guid'"+t.id+"')",$expand:"Tags,Group/Channel,Comments"},function(t){var u,i,f,r;if(n.entity=t.value[0],n.entity.Group&&(n.channelId=n.entity.Group.Channel.ChannelId,n.groupId=n.entity.Group.GroupId),n.entity.Url||n.translateTitle(),n.entity.Tags){for(n.tags="",r=n.entity.Tags,i=0,f=r.length;i<f;i++)u=r[i],n.tags+=","+u.Name;n.tags=n.tags.substring(1)}return n.loading=""})):n.entity={}}),n.getGroups=function(){var i,t,u,r;if(n.channels.value===void 0)return void 0;for(r=n.channels.value,t=0,u=r.length;t<u;t++)if(i=r[t],i.ChannelId===n.channelId)return i.Groups},n.submit=function(){if(n.isSubmit=!0,!n.form.$invalid)return n.channelValid()?n.groupValid()?(n.loading="Saving",n.files.length?u.upload():c()):void 0:void 0},n.channelValid=function(){return n.channels.value},n.groupValid=function(){return n.groupId},c=function(){var r,u,e,s,o;if(r=n.entity,r.Group={},r.Group.GroupId=function(){var t,f,i,r;for(i=n.getGroups(),r=[],t=0,f=i.length;t<f;t++)u=i[t],u.GroupId===n.groupId&&r.push(u);return r}()[0].GroupId,r.Tags=[],n.tags)for(o=n.tags.split(","),e=0,s=o.length;e<s;e++)u=o[e],r.Tags.push({TagId:UUID.generate(),Name:u});return t.id?f.update({id:"(guid'"+r.PostId+"')"},r,function(n){return i.location.href="/post/"+n.Url},function(){return n.loading=""}):(r.PostId=UUID.generate(),f.save(r,function(n){return i.location.href="/post/"+n.Url},function(){return n.loading=""}))},n.remove=function(){return message.confirm(function(){var t;return n.loading="Deleting",t=n.entity,t.IsDeleted=!0,f.update({id:"(guid'"+t.PostId+"')"},t,function(){return message.success("Delete post successfully."),i.location.href="/admin/article"})})},n.files=[],n.removeImg=function(t){var e,r,i,o,f;for(f=n.files,i=0,o=f.length;i<o;i++)r=f[i],r.name===t.name&&(e=r);return n.files.splice(n.files.indexOf(e),1),u.cancel(t)},n.removeServerImg=function(){return n.entity.Thumbnail=null},r.$on("fileAdded",function(t,i){return n.files.push(i),n.$apply()}),r.$on("fileUploaded",function(t,i){return n.entity.Thumbnail=i.result,c()}),h=void 0,n.translateTitle=function(){if(n.entity.Title)return h&&o.cancel(h),h=o(function(){return n.Translating=!0,s.events(n.entity.Title).success(function(t){return t=$.trim(t),t=t.toLowerCase(),t=t.replace(/[^_a-zA-Z\d\s]/g,""),t=t.replace(/[\s]/g,"-"),n.entity.Url=t,n.Translating=!1})},500)}}])