angular.module("article-detail",["resource.articles","resource.comments"]).config(["$routeProvider",function(n){return n.when("/post/:url",{templateUrl:"/Content/app/article/detail/article-detail.tpl.html",controller:"ArticleDetailCtrl",resolve:{article:["$route","$q","Article",function(n,t,i){var r;return r=t.defer(),i.get({$filter:"Url eq '"+n.current.params.url+"' and IsDeleted eq false"},function(n){return r.resolve(n.value[0])}),r.promise}]}})}]).controller("ArticleDetailCtrl",["$scope","$window","$translate","$routeParams","progressbar","Article","Comment","article",function(n,t,i,r,u,f,e,o){var h,c,s,p,a,l,w,b,v,y;if(n.$parent.showBanner=!1,n.loading=i("global.loading"),n.url=r.url,n.item=o,n.loading="",!n.item){n.$parent.title="404";return}if(n.$parent.title=n.item.Title,codeformat(),n.prevPost=f.nav({$filter:"IsDeleted eq false and CreateDate lt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate desc"}),n.nextPost=f.nav({$filter:"IsDeleted eq false and CreateDate gt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate"}),n.item.Tags.length){for(s="",v=n.item.Tags,h=a=0,w=v.length;a<w;h=++a)p=v[h],s+=" or Tags/any(tag"+h+":tag"+h+"/Name eq '"+p.Name+"')";s=s.substring(4);s="IsDeleted eq false and PostId ne (guid'"+n.item.PostId+"') and ("+s+")";n.relatedPost=f.related({$filter:s,$orderby:"CreateDate desc"})}for(y=n.item.Comments,l=0,b=y.length;l<b;l++)c=y[l],c.Avatar||(c.Avatar=c.Email?"http://www.gravatar.com/avatar/"+md5(c.Email):"/Content/img/avatar.png");return f.browsed({id:"(guid'"+n.item.PostId+"')"}),n.entity={},n.$watch("User",function(){if(n.User)return n.entity.Author=n.User.UserName,n.entity.Email=n.User.Email,n.entity.Url=n.User.Url,n.AuthorForDisplay=n.User.UserName,n.editmode=n.User.UserName===""||!(n.User.UserName!=null)}),n.del=function(n){return message.confirm(function(){return e.del({id:n.CommentId},function(){return message.success("“#"+n.Content+"”  be moved to trash."),n.IsDeleted=!0},function(n){var t;return message.error((t=n.data.ExceptionMessage)!=null?t:n.status)})})},n.save=function(){if(n.submitted=!0,!n.form.$invalid)return u.start(),n.loading=i("global.post"),n.entity.CommentId=UUID.generate(),e.save(n.entity,function(t){return message.success(i("article.comment.complete")),n.item.Comments.push(t),n.entity.Content="",n.AuthorForDisplay=t.Author,n.editmode=!1,n.submitted=!1,f.commented({id:"(guid'"+n.item.PostId+"')"}),u.complete(),n.loading=""},function(t){var i;return n.submitting=!1,message.error((i=t.data.ExceptionMessage)!=null?i:t.status)})},n.remove=function(n){return message.confirm(function(){return e.remove({id:"(guid'"+n.CommentId+"')"},function(){return n.IsDeleted=!0,message.success("Comment has been removed.")})})},n.edit=function(n){return t.location.href="/admin/article('"+n.PostId+"')"}}])