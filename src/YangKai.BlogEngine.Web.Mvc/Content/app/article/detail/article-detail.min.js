angular.module("article-detail",["resource.articles","resource.comments"]).config(["$routeProvider",function(n){return n.when("/post/:url",{templateUrl:"/Content/app/article/detail/article-detail.tpl.html",controller:"ArticleDetailCtrl",resolve:{article:["$route","$q","Article",function(n,t,i){var r;return r=t.defer(),i.getOnce({$filter:"Url eq '"+n.current.params.url+"' and IsDeleted eq false",$expand:"Tags,Group/Channel,Comments"},function(n){return r.resolve(n.value[0])}),r.promise}]}})}]).controller("ArticleDetailCtrl",["$scope","$rootScope","$window","$translate","$routeParams","progressbar","Article","Comment","article","account",function(n,t,i,r,u,f,e,o,s,h){var l,a,c,b,y,v,k,d,p,w;if(n.$parent.showBanner=!1,n.item=s,!n.item){t.title="404";return}if(t.title=n.item.Title,codeformat(),n.prevPost=e.getOnce({$select:"Url,Title",$filter:"IsDeleted eq false and CreateDate lt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate desc"}),n.nextPost=e.getOnce({$select:"Url,Title",$filter:"IsDeleted eq false and CreateDate gt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate"}),n.item.Tags.length){for(c="",p=n.item.Tags,l=y=0,k=p.length;y<k;l=++y)b=p[l],c+=" or Tags/any(tag"+l+":tag"+l+"/Name eq '"+b.Name+"')";c=c.substring(4);c="IsDeleted eq false and PostId ne (guid'"+n.item.PostId+"') and ("+c+")";n.relatedPost=e.getOnce({$top:8,$select:"Url,Title,PubDate",$filter:c,$orderby:"CreateDate desc"})}for(w=n.item.Comments,v=0,d=w.length;v<d;v++)a=w[v],a.Avatar||(a.Avatar=a.Email?"http://www.gravatar.com/avatar/"+md5(a.Email):"/Content/img/avatar.png");return e.browsed({id:"(guid'"+n.item.PostId+"')"}),h.get().then(function(t){return n.entity={Author:t.UserName,Email:t.Email,Url:t.Url},n.editmode=!t.UserName}),n.del=function(n){return message.confirm(function(){return o.del({id:n.CommentId},function(){return message.success("“#"+n.Content+"”  be moved to trash."),n.IsDeleted=!0},function(n){var t;return message.error((t=n.data.ExceptionMessage)!=null?t:n.status)})})},n.save=function(){if(n.submitted=!0,!n.form.$invalid)return f.start(),n.loading=r("global.post"),n.entity.CommentId=UUID.generate(),n.entity.Post={PostId:n.item.PostId},o.save(n.entity,function(t){return message.success(r("article.comment.complete")),n.item.Comments.push(t),n.entity.Content="",e.commented({id:"(guid'"+n.item.PostId+"')"}),f.complete(),n.submitted=!1,n.loading=""},function(){return n.submitted=!1,n.loading=""})},n.remove=function(n){return message.confirm(function(){return o.remove({id:"(guid'"+n.CommentId+"')"},function(){return n.IsDeleted=!0,message.success("Comment has been removed.")})})},n.edit=function(n){return i.location.href="/admin/article('"+n.PostId+"')"}}])