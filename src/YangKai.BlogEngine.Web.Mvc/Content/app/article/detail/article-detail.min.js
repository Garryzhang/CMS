angular.module("article-detail",[]).config(["$routeProvider",function(n){return n.when("/post/:url",{templateUrl:"/Content/app/article/detail/article-detail.tpl.html",controller:"ArticleDetailCtrl"})}]).controller("ArticleDetailCtrl",["$scope","$translate","$routeParams","progressbar","Article","Comment",function(n,t,i,r,u,f){return n.$parent.showBanner=!1,n.loading=t("global.loading"),n.url=i.url,u.get({$filter:"Url eq '"+n.url+"' and IsDeleted eq false"},function(t){var r,f,i,c,o,e,l,a,s,h;if(n.item=t.value[0],n.loading="",!n.item){n.$parent.title="404";return}if(n.$parent.title=n.item.Title,codeformat(),n.entity.PostId=n.item.PostId,n.prevPost=u.nav({$filter:"IsDeleted eq false and CreateDate lt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate desc"}),n.nextPost=u.nav({$filter:"IsDeleted eq false and CreateDate gt datetime'"+n.item.CreateDate+"' and Group/Url eq '"+n.item.Group.Url+"'",$orderby:"CreateDate"}),n.item.Tags.length){for(i="",s=n.item.Tags,r=o=0,l=s.length;o<l;r=++o)c=s[r],i+=" or Tags/any(tag"+r+":tag"+r+"/Name eq '"+c.Name+"')";i=i.substring(4),i="IsDeleted eq false and PostId ne (guid'"+n.item.PostId+"') and ("+i+")",n.relatedPost=u.related({$filter:i,$orderby:"CreateDate desc"})}for(h=n.item.Comments,e=0,a=h.length;e<a;e++)f=h[e],f.Gravatar=f.Email?"http://www.gravatar.com/avatar/"+md5(f.Email):"/Content/img/avatar.png";return u.browsed({id:"(guid'"+n.item.PostId+"')"})}),n.entity={},n.$watch("User",function(){if(n.User)return n.entity.Author=n.User.UserName,n.entity.Email=n.User.Email,n.entity.Url=n.User.Url,n.AuthorForDisplay=n.User.UserName,n.editmode=n.User.UserName===""||!(n.User.UserName!=null)}),n.del=function(n){return message.confirm(function(){return f.del({id:n.CommentId},function(){return message.success("“#"+n.Content+"”  be moved to trash."),n.IsDeleted=!0},function(n){var t;return message.error((t=n.data.ExceptionMessage)!=null?t:n.status)})})},n.save=function(){return r.start(),n.loading=t("global.post"),n.entity.CommentId=UUID.generate(),f.save(n.entity,function(i){return message.success(t("article.comment.complete")),n.item.Comments.push(i),n.entity.Content="",n.AuthorForDisplay=i.Author,n.editmode=!1,angular.resetForm(n,"form"),u.commented({id:"(guid'"+n.item.PostId+"')"}),r.complete(),n.loading=""},function(n){var t;return message.error((t=n.data.ExceptionMessage)!=null?t:n.status)})},n.remove=function(n){return f.remove({id:"(guid'"+n.CommentId+"')"},function(){return n.IsDeleted=!0,message.success("Comment has been removed.")})}}])